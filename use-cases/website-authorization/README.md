## OAuth Website Authorization

The authorization model for the Selling Partner API is based on Login with Amazon: Amazon's implementation of OAuth 2.0. In this model your application is authorized through interactions with pages displayed by Amazon and by your website.

The website authorization workflow (OAuth) is initiated from your own website. Selling partners sign in to your website and select an Authorize button that you configure to initiate authorization. For more information, refer to the following steps

We recommend the following resources for more details on authorization with the Selling Partner API:
[Authorizing Selling Partner API Applications](https://developer-docs.amazon.com/sp-api/docs/authorizing-selling-partner-api-applications)
[Website Authorization Workflow](https://developer-docs.amazon.com/sp-api/docs/website-authorization-workflow)

## Solution

This sample solution is an implementation of the Login with Amazon website authorization workflow. This web app can be deployed as a sample developer website and configured with your developer application to initiate the authorization workflow, from the selling partner clicking on an Authorize button until retrieving the Refresh Token and executing a first successful API call.

The solution works in the following steps:
1. A landing page with an Authorize button is visited
2. The selling partner clicks on the Authorize button. The web app constructs the OAuth URL and redirects the selling partner
3. The selling partner consents and authorizes your website on seller/vendor central. Amazon redirects the user to the configured redirect URI (website) with the selling partner authorization code
4. The web app exchanges the authorization code for a refresh token
5. The web app exchanges the refresh token for an access token and calls the Sellers API operation to get the selling partner marketplace participations.

Note:
- The solution implements authorization for an application in the DRAFT status. For this, a **version=beta** query parameter is added to the OAuth URL. If your application is already in status PUBLISHED, simply remove this parameter [here](/code/python/application.py#L12)
- Please note cross-site request forgery risks. A state value generated by the application is passed during the authorization process. This solution doesn't implement a short-lived state token and its corresponding validation
- At step 4, the refresh token should be stored in safe and secure storage for subsequent access tokens retrievals 

If you want to deploy and test the proposed solution, follow the steps under [Deployment](docs/DEPLOYMENT.md).

## Step-by-step Sample code

#### 1 - Landing page:

Below you can find the sample website landing page with an "Authorize" button.
For brevity, only the html body is provided.

```python (Flask)
@application.route("/")
def hello():
    return render_template("index.html")
```

```html
<body>
    <div class="container">
        Welcome to SP-API Auth Sample Application
        <p><a href="https://developer-docs.amazon.com/sp-api/docs/website-authorization-workflow">Read more on the website authorization workflow here</a></p>
    </div>

    <div class="container">
        <h2>Click the Authorize button below to start the process</h1>
        <a href="{{ url_for('redirect_oauth') }}">
            <button>Authorize</button>
        </a>
    </div>
</body>
```

#### 2 - OAuth URL construction and redirection:

Below you can find the sample code for the Authorize button handler, constructing the OAuth URL and redirecting the selling partner.

```python (Flask)
SELLER_VENDOR_CENTRAL_URL_NA = "https://sellercentral.amazon.com"
APP_AUTH_PATH = f"/apps/authorize/consent?application_id={APPLICATION_ID}&state={uuid.uuid4()}&version=beta"

@application.route("/authorize")
def redirect_oauth():
    return redirect(f"{SELLER_VENDOR_CENTRAL_URL_NA}{APP_AUTH_PATH}")
```

#### 3 - Post-Consent Authorization handler

Below you can find the sample code for post-consent handling.

```python (Flask)
@application.route(f"{APPLICATION_REDIRECT_URI}")
def handle_authorization_redirect():
    spapi_oauth_code = request.args["spapi_oauth_code"]
    state = request.args["state"] #Verify the state token for cross-site request forgery
    selling_partner_id = request.args["selling_partner_id"] # Store the selling partner merchant token or vendor group code
    ...
```

#### 4 - Exchange the authorization code for a refresh token

Below you can find the sample code for Auth Code to Refresh Token exchange

```python (Flask)
@application.route(f"{APPLICATION_REDIRECT_URI}")
def handle_authorization_redirect():
    ...
    refresh_token = ApiUtils._get_lwa_refresh_token(spapi_oauth_code=spapi_oauth_code) # Store the refresh token safely for further authorizations.
```

```python
def _get_lwa_refresh_token(spapi_oauth_code):
        code_exchange_grant_type = "authorization_code"
        url = Constants.LWA_ENDPOINT
        http = urllib3.PoolManager()
        payload = {
            'client_id': Constants.CLIENT_ID,
            'client_secret': Constants.CLIENT_SECRET,
            'code': spapi_oauth_code,
            'grant_type': code_exchange_grant_type
        }
        
        data = urllib.parse.urlencode(payload)
        headers = {'Content-Type': 'application/x-www-form-urlencoded'}
        try:
            response = http.request('POST', url, headers=headers, body=data)
            print('Status code:', response.status)
            json_response = json.loads(response.data)
        except Exception as e:
            print(str(e))
        else:
            selling_partner_refresh_token = json_response.get('refresh_token')
            # Store refresh token in safe storage
            # Retrieve and exhange with access_token as needed
            return selling_partner_refresh_token
```

#### 5 - Get an access token and call Sellers API's getMarketplaceParticipations (seller only)

Below you can find the sample code for getting an access token using the refresh token and calling the sellers API to retrieve the selling partner's marketplace participations, and displaying the result in the web page.

```python (Flask)
@application.route(f"{APPLICATION_REDIRECT_URI}")
def handle_authorization_redirect():
    ...
    if "sellercentral" in SELLER_VENDOR_CENTRAL_URL:
        marketplaceParticipations = getMarketplaceParticipations(refresh_token)
        return render_template("authorized.html", response=marketplaceParticipations)
    else:
        # Sellers API is for sellers only. Vendors APIs can be called at this point.
        return render_template("authorized.html", response=None)

def getMarketplaceParticipations(refresh_token):
    region_code = Constants.NA_REGION_CODE
    use_sandbox = "No"
    api_utils = ApiUtils(refresh_token, region_code, 'sellers', use_sandbox)
    return api_utils.call_sellers_api(method='get_marketplace_participations')
```

For brevity, only the html body is provided:

```html
<div class="container">
    <p class="highlight">Thanks for authorizing the SP-API Sample App</p>

    {% if response.payload %}
    <div class="response">
        <p>Your marketplace participations are:</p>
        <ul>
            {% for item in response.payload %}
            <li>
                <strong>ID:</strong> {{ item.marketplace.id }}<br>
                <strong>Name:</strong> {{ item.marketplace.name }}<br>
                <strong>Country Code:</strong> {{ item.marketplace.countryCode }}
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}
</div>
```
